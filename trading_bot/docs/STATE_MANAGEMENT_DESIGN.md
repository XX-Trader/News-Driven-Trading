# Trading Bot 状态管理设计文档 (简化版)

**版本**: v1.1.0
**最后更新**: 2025-11-23
**文档状态**: 已更新 (简化设计)

---

## 1. 概述

### 1.1 设计目标

构建一个轻量级、可靠的状态管理系统，确保在程序重启或异常退出后能够恢复关键业务状态。

### 1.2 核心原则

1.  **极度简化**: 移除复杂的系统状态机 (FSM) 和状态查询 API。
2.  **立即存储**: 关键状态变更（如推文处理完成、订单生成）立即写入本地文件。
3.  **断点续传**: 启动时读取本地文件，恢复未完成的任务。

---

## 2. 状态存储架构

### 2.1 存储方式

采用 **内存 + 本地 JSON 文件** 的双层存储结构。

- **内存**: 运行时快速读写。
- **文件**: 状态变更时立即同步写入，确保数据安全。

### 2.2 核心状态文件

系统仅维护以下核心状态文件：

1.  **推文处理记录**: `data/tweet_records.json`
    - 记录已处理的推文 ID、处理结果、AI 分析结果。
    - 用于去重和历史回溯。

2.  **持仓状态**: `data/positions.json`
    - 记录当前持有的仓位信息、入场价格、止损止盈设置。
    - 用于程序重启后恢复持仓监控。

---

## 3. 状态管理流程

### 3.1 启动与恢复 (断点续传)

1.  **加载配置**: 读取 `config.py`。
2.  **加载状态**:
    - 读取 `data/tweet_records.json` 到内存，构建已处理推文集合。
    - 读取 `data/positions.json` 到内存，恢复活跃持仓对象。
3.  **恢复监控**:
    - 遍历活跃持仓，重新启动价格监控和止损止盈检查任务。
    - 确保之前的交易计划继续执行。

### 3.2 运行时状态同步

- **推文处理**:
    - 当 AI 分析完成并生成信号后，立即更新 `tweet_records.json`。
    - 确保即使程序崩溃，重启后也不会重复处理同一推文。

- **交易执行**:
    - 当订单成交生成持仓后，立即写入 `positions.json`。
    - 当持仓平仓后，从 `positions.json` 中移除（或标记为已平仓）。

---

## 4. 异常处理

### 4.1 崩溃恢复

- 程序启动时自动检查是否存在未完成的持仓。
- 如果存在，自动启动监控任务，无需人工干预。

### 4.2 文件损坏保护

- 写入文件时采用“写入临时文件 -> 重命名”的原子操作方式，防止写入过程中断电导致文件损坏。

---

## 5. 总结

本设计移除了所有非必要的复杂性，专注于“数据不丢失”和“任务可恢复”两个核心目标。通过简单的 JSON 文件存储和启动时的恢复逻辑，实现了系统的健壮性。
