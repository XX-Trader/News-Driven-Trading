# 推特抢跑 Notebook 验证需求说明

## 版本信息
- **版本号**：v0.1.1
- **日期**：2025-11-14
- **撰写人**：AI 助手
- **适用范围**：`推特抢跑/twitter_analysis.ipynb` Notebook 开发与验证

---

## 背景与目标
1. **背景**  
   - 已拥有脚本 [`twitter_crawler_functional_min.py`](推特抢跑/twitter_crawler_functional_min.py:1)（核心函数包括 `load_local_json_strict()` 与 `ai_analyze_text()`），可抓取 CZ 推文并保存到本地 `latest.json`。
   - 用户希望在 Notebook 中验证“推文 → AI 分析 → Binance K 线”的全链路流程，并严格对齐 Twitter 展示的本地时间（UTC+8）和币安 K 线时间。

2. **主要目标**  
   - 在 `推特抢跑/twitter_analysis.ipynb` 内完成：  
     1. 读取本地 `twitter_media/latest.json` 中 `data["tweets"][page]` 的推文；  
     2. 实时调用 `ai_analyze_text()` 获取 AI 分析结果；  
     3. 根据推文内容 / AI 输出推断交易对（若无法推断，视为“不可交易”，直接结束流程）；  
     4. 对可交易推文，**以推文的本地时间（UTC+8）为中心**，获取 Binance 现货 1m K 线（前后各 15 分钟）并绘制；  
     5. 在 Notebook 中清晰展示输入、AI 输出与图表，图下注明推文时间（UTC 与 UTC+8）与 AI 结论；  
     6. 图表 X 轴为本地时间（UTC+8），Y 轴为价格。

---

## 输入与数据源
| 项目 | 说明 |
| --- | --- |
| 推文数据 | `推特抢跑/twitter_media/latest.json`，结构遵循 `data["tweets"][page]` |
| AI 分析函数 | 复用脚本中的 `ai_analyze_text()`（支持代理配置） |
| Binance API | `https://api.binance.com/api/v3/klines`，`interval=1m`，窗口：以“推文本地时间(UTC+8)”前后各 15 分钟为中心计算 `startTime/endTime`（毫秒时间戳） |

---

## 关键流程（Notebook 结构草图）

1. **配置单元**  
   - 导入依赖、设定文件路径 / 页码 / K 线窗口（默认 ±15 分钟）。
   - 固定本地时区偏移为 `UTC+8`。

2. **数据加载**  
   - 通过 `load_single_tweet(path, page)` 读取指定页推文，结构为 `data["tweets"][page]` 或顶层 list。
   - 使用 `parse_tweet_time(tweet)` 将 `createdAt`（如 `Thu Nov 13 16:25:19 +0000 2025`）解析为带时区信息的 UTC `datetime`。
   - 使用 `to_local_time(utc_dt, offset_hours=8)` 转换为本地时间（UTC+8）。

3. **AI 调用**  
   - 调用 `ai_analyze_text()` 对推文文本进行分析。
   - 使用 `call_ai_for_tweet(text)` 包装 AI 调用，优先尝试按 JSON 解析，失败则返回 `{"raw": 原始字符串}`。
   - 使用 `pretty_print_ai(ai_res)` 以多行 JSON 格式（`indent=2`）或原始多行字符串输出 AI 分析结果。

4. **交易对判定**  
   - `normalize_symbol_from_ai(ai_res)`：优先读取 AI 输出字段“交易币种”，支持 list / str，转换为大写基础币种（如 BTC）后通过 `SYMBOL_MAP` 映射到 Binance symbol（如 `BTCUSDT`）。  
   - `fallback_symbol_from_text(text)`：当 AI 无法给出有效币种时，在原文中用关键词（BTC、ETH、BNB、SOL、DOGE）做兜底匹配。  
   - `detect_trade_symbol(ai_res, text)`：综合上述两步，若仍无法判定则返回 `None`，视为“不可交易”，**不再请求 K 线**。

5. **行情获取与绘图**  
   - 使用 `run_analysis(page: int)` 作为统一入口：  
     1. 读取第 `page` 条推文并打印：  
        - 推文 ID  
        - 原始 UTC 时间：`createdAt`  
        - 本地时间：`%Y-%m-%d %H:%M:%S (UTC+8)`  
        - 原文文本  
     2. 调用 AI，打印美化后的多行结果。  
     3. 判定交易对 `symbol`、交易方向 `direction`、置信度 `confidence`。  
     4. 若 `symbol` 为 `None`：打印“无法确定交易对，跳过 Binance K 线”。  
     5. 若存在 `symbol`：  
        - 以 **推文本地时间 (UTC+8)** 为中心、使用 `WINDOW_MINUTES`（默认 15）计算：  
          - `start = local_time - 15min`  
          - `end = local_time + 15min`  
        - 将本地时间转换为 Unix 时间戳（毫秒）：  
          - `startTime = int(start.timestamp() * 1000)`  
          - `endTime = int(end.timestamp() * 1000)`  
        - 使用上述时间戳调用 Binance `/api/v3/klines` 获取 1m K 线。  
        - 使用 `format_klines()` 将原始 K 线转为 `(times, opens, highs, lows, closes)`，其中 `times` 为本地时间 `datetime`。  
        - 使用 `plot_candles()` 绘制 1m K 线：  
          - X 轴为本地时间（UTC+8），自动设置时间刻度并调用 `AutoDateLocator` + `DateFormatter("%m-%d %H:%M")`；  
          - Y 轴为价格；  
          - 使用蓝色竖线标出推文本地时间；  
          - 下方用文字说明：  
            - `Tweet UTC: yyyy-MM-dd HH:mm:ss +0000`  
            - `Tweet Local (UTC+8): yyyy-MM-dd HH:mm:ss`。

6. **结果总结**  
   - `run_analysis()` 结尾输出 `SUMMARY` 字典，包含：  
     - `tweet_id`  
     - `created_at_utc`（原始 `createdAt` 字符串）  
     - `created_at_local`（本地 UTC+8 时间，ISO 格式）  
     - `symbol`  
     - `direction`  
     - `confidence`  
   - 若无交易对则明确提示“无法确定交易对，跳过 Binance K 线”；若有交易对则表示已完成 K 线展示。

---

## 约束与规范

- Notebook 单元 **≤ 20 行**，仅使用函数与变量（禁止类定义）。
- **不可硬编码**：常量需在配置区集中声明；如必须硬编码（例如支持的基础币种列表），需在文档说明原因。
- **时间处理**：  
  - 必须先将 Twitter 返回的 UTC 时间（如 `Thu Nov 13 16:25:19 +0000 2025`）解析为 UTC `datetime`；  
  - 再转换为本地时间 `UTC+8`，并以 `yyyy-MM-dd HH:mm:ss` 格式展示；  
  - 获取 Binance K 线时，以本地时间 (UTC+8) 为中心计算窗口，并使用该本地时间计算 Unix 毫秒时间戳作为 `startTime/endTime`。
- **AI 调用**：  
  - 必须复用现有 `ai_analyze_text()` 及代理逻辑（`USE_OPENAI_PROXY`），不在 Notebook 内重写请求细节。  
  - 使用 `pretty_print_ai()` 以多行 JSON 格式输出 AI 结果；若非 JSON，则以原始字符串多行输出。
- **Binance K 线**：  
  - 仅适用于“可交易”推文；无法判定交易对时必须跳过行情步骤。  
  - 当前默认支持的币种映射：BTC / ETH / BNB / SOL / DOGE → 对应 `*USDT` 交易对，可后续扩展。
- **统一运行入口**：  
  - Notebook 必须提供 `run_analysis(page: int)` 函数，作为端到端运行指定 `data["tweets"][page]` 的唯一入口；  
  - Notebook 示例 cell 中应提供调用示例，例如 `run_analysis(0)`，方便用户通过修改参数快速切换推文。
- **文件结构**：  
  - Notebook 位于 `推特抢跑/twitter_analysis.ipynb`；  
  - 需求文档位于 `推特抢跑/需求确认.md`，后续变更需在此文件中更新版本与说明。  
- 不编写额外测试代码；不删除现有脚本（除非得到明确批准）。

---

## 成功判据（DoD）

1. Notebook 一键运行成功，输出流程完整且无报错。
2. `run_analysis(page)` 对任意一条推文运行时，应展示：
   - 原始推文文本；
   - UTC 时间与转换后的本地 UTC+8 时间（格式为 `yyyy-MM-dd HH:mm:ss`）；
   - AI 分析结果（多行 JSON / 多行原始字符串）；
   - 推断出的交易对、交易方向、置信度。
3. 当能确定交易对时：
   - 从 Binance 获取的 1m K 线能覆盖本地时间（UTC+8）前后各 15 分钟的区间；
   - 图表 X 轴为本地时间（UTC+8），Y 轴为价格；
   - 图中用竖线明确标注推文本地时间；
   - 图下方以文字清楚标注 Tweet 的 UTC 时间与本地 UTC+8 时间。
4. 当无法确定交易对时：
   - Notebook 清晰提示“无法确定交易对，视为不可交易，跳过 Binance K 线”；
   - 不发送任何 K 线请求。
5. 若 Notebook 调用逻辑对项目有进一步影响，需在后续 `CLAUDE.md` 中记录版本 + 注意事项。
6. 文档、命名、风格与现有项目保持一致；可复现运行步骤已在 Notebook 冒头或文档中说明。

---

## 后续任务清单

1. 基于本版本说明继续迭代 Notebook（如扩展支持的币种或调整窗口参数），并保持与文档对齐。  
2. 使用 `run_analysis(page)` 对多条典型推文（包含有图/无图、多币种等场景）做端到端验证，保存执行结果截图。  
3. 如引入更复杂逻辑或跨模块改动，在项目根目录新增/更新 `CLAUDE.md`，记录版本、流程与依赖。  
4. 根据实盘/回测情况，进一步完善交易对判定规则与图表标注（例如标记涨跌方向、价格变化区间等）。
